<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.37" />
    <meta name="description" content="Documentation for Fission">
<meta name="google-site-verification" content="5AvQfeDvIx0ldE9uSKVsoikqgFknd_CT18caf9TNoVg" />
<meta name="author" content="Fission">

    <link rel="shortcut icon" href=/0.12.0/images/favicon.png type="image/x-icon" />
<link rel="icon" href=/0.12.0/images/favicon.png type="image/x-icon" />

    <title>Supporting Canary Deployments for Fission Functions :: Serverless Functions for Kubernetes</title>
    
    
    <link href="/0.12.0/css/nucleus.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/font-awesome.min.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/hybrid.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/featherlight.min.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/perfect-scrollbar.min.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/auto-complete.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/theme.css?1541109125" rel="stylesheet">
    <link href="/0.12.0/css/hugo-theme.css?1541109125" rel="stylesheet">
    
      <link href="/0.12.0/css/theme-fission.css?1541109125" rel="stylesheet">
    

    <script src="/0.12.0/js/jquery-2.x.min.js?1541109125"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/0.12.0/usage/canary-deployments/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://fission.io/">
  <img src=/0.12.0/images/fission-logo.png>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/0.12.0/js/lunr.min.js?1541109125"></script>
<script type="text/javascript" src="/0.12.0/js/auto-complete.js?1541109125"></script>
<script type="text/javascript">
    
        var baseurl = '\/0.12.0';
    
</script>
<script type="text/javascript" src="/0.12.0/js/search.js?1541109125"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/0.12.0/installation/" title="Installing Fission" class="dd-item 
        
        
        parent
        ">
      <a href="/0.12.0/installation/">
          Installing Fission
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/installation/kubernetessetup/" title="Kubernetes Quick Install" class="dd-item ">
        <a href="/0.12.0/installation/kubernetessetup/">
        Kubernetes Quick Install
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/0.12.0/installation/upgrade/" title="Upgrading Fission" class="dd-item 
        
        
        
        ">
      <a href="/0.12.0/installation/upgrade/">
          Upgrading Fission
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/installation/env_vars/" title="Environment Variables" class="dd-item ">
        <a href="/0.12.0/installation/env_vars/">
        Environment Variables
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/concepts/" title="Fission Concepts" class="dd-item 
        
        
        parent
        ">
      <a href="/0.12.0/concepts/">
          Fission Concepts
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/concepts/basic-concept/" title="Basic Concepts" class="dd-item ">
        <a href="/0.12.0/concepts/basic-concept/">
        Basic Concepts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/concepts/executor/" title="Fission Function Executors" class="dd-item ">
        <a href="/0.12.0/concepts/executor/">
        Fission Function Executors
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/usage/" title="Using Fission" class="dd-item 
        parent
        
        parent
        ">
      <a href="/0.12.0/usage/">
          Using Fission
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/package/" title="Packaging source code" class="dd-item ">
        <a href="/0.12.0/usage/package/">
        Packaging source code
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/access-secret-cfgmap-in-function/" title="Accessing Secrets in Functions" class="dd-item ">
        <a href="/0.12.0/usage/access-secret-cfgmap-in-function/">
        Accessing Secrets in Functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/environments/" title="Environments" class="dd-item ">
        <a href="/0.12.0/usage/environments/">
        Environments
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/functions/" title="Functions" class="dd-item ">
        <a href="/0.12.0/usage/functions/">
        Functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/trigger/" title="Triggers" class="dd-item ">
        <a href="/0.12.0/usage/trigger/">
        Triggers
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/executor/" title="Controlling Function Execution" class="dd-item ">
        <a href="/0.12.0/usage/executor/">
        Controlling Function Execution
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/developer-workflow/" title="Source Code Organization and Your Development Workflow" class="dd-item ">
        <a href="/0.12.0/usage/developer-workflow/">
        Source Code Organization and Your Development Workflow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/ingress-tutorial/" title="Exposing functions with Ingress" class="dd-item ">
        <a href="/0.12.0/usage/ingress-tutorial/">
        Exposing functions with Ingress
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/usage/canary-deployments/" title="Supporting Canary Deployments for Fission Functions" class="dd-item active">
        <a href="/0.12.0/usage/canary-deployments/">
        Supporting Canary Deployments for Fission Functions
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/languages/" title="Languages" class="dd-item 
        
        
        parent
        ">
      <a href="/0.12.0/languages/">
          Languages
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/languages/nodejs/" title="Fission functions with Nodejs" class="dd-item ">
        <a href="/0.12.0/languages/nodejs/">
        Fission functions with Nodejs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/languages/go/" title="Using Go with Fission" class="dd-item ">
        <a href="/0.12.0/languages/go/">
        Using Go with Fission
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/languages/java/" title="Using Java with Fission JVM environment" class="dd-item ">
        <a href="/0.12.0/languages/java/">
        Using Java with Fission JVM environment
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/tutorial/" title="Tutorials" class="dd-item 
        
        
        
        ">
      <a href="/0.12.0/tutorial/">
          Tutorials
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/tutorial/enabling-istio-on-fission/" title="Enabling Istio on Fission" class="dd-item ">
        <a href="/0.12.0/tutorial/enabling-istio-on-fission/">
        Enabling Istio on Fission
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/0.12.0/tutorial/java-example/" title="Building Java Functions" class="dd-item ">
        <a href="/0.12.0/tutorial/java-example/">
        Building Java Functions
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/workflows/" title="Fission Workflows" class="dd-item 
        
        
        
        ">
      <a href="/0.12.0/workflows/">
          Fission Workflows
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/0.12.0/contributing/" title="Contributing to Fission" class="dd-item 
        
        
        parent
        ">
      <a href="/0.12.0/contributing/">
          Contributing to Fission
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li class="" role=""> 
                  <a class="padding" href="https://github.com/fission/fission"><i class='fa fa-fw fa-github'></i> Github repo</a>
              </li>
          
              <li class="" role=""> 
                  <a class="padding" href="https://github.com/fission/fission/graphs/contributors"><i class='fa fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/fission/docs.fission.io/edit/master/docs/content/usage/canary-deployments.md" target="blank">
                      <i class="fa fa-code-fork"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/0.12.0/'>Fission</a> > <a href='/0.12.0/usage/'>Using Fission</a> > Supporting Canary Deployments for Fission Functions
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#setup-pre-requisites">Setup &amp; pre-requisites</a>
<ul>
<li><a href="#canary-config-parameters">Canary Config parameters</a></li>
<li><a href="#steps-to-setup-a-canary-config">Steps to setup a canary config</a></li>
<li><a href="#steps-to-verify-the-status-of-a-canary-deployment">Steps to verify the status of a canary deployment</a></li>
<li><a href="#note">Note</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Supporting Canary Deployments for Fission Functions</h1>
          

        




<p>This tutorial will walk you through setting up a canary config such that a new version of a function can be deployed in production with minimal risk in a way that it gradually receives
user traffic all the way from 0% to 100% eventually.</p>

<h2 id="setup-pre-requisites">Setup &amp; pre-requisites</h2>

<p>This feature is dependent on Prometheus metrics to check the health of the new version of the function before incrementing
the percentage of user traffic to the new version of the function can be incremented at every interval that is configured.</p>

<p>Hence, Prometheus needs to be deployed and is listed as a dependency for fission chart. Issuing a <code>helm dependency update</code> before <code>helm install</code> of fission ensures the prometheus chart is fetched and installed alongside fission.</p>

<h3 id="canary-config-parameters">Canary Config parameters</h3>

<p>A Canary Config has the following parameters :</p>

<p>duration: Specifies how frequently user traffic needs to be incremented for the new version of function</p>

<p>failurethreshold: Specifies the threshold in percentage beyond which the new version of a function is declared unhealthy</p>

<p>funcn: Specifies the name of the latest version of the function</p>

<p>funcn-1: Specifies the name of the current stable version of the function</p>

<p>trigger: Specifies the name of the http trigger object</p>

<p>weightincrement: Specifies the percentage increase of user traffic towards the new version of the function</p>

<p>failureType: Specifies the parameter for checking the health of the new version of a function. For now, the only supported type is <code>status-code</code> which is the http status code. So if a function returns a status code other than 200, its considered to be unhealthy.</p>

<p>For example, let&rsquo;s say the current stable version of a function is fna-v1 and the latest version of a function is fna-v2. Let&rsquo;s suppose we want to increment the traffic towards the new version in steps of 30% every 1m with a failure threshold of 10%. For such a scenario, the sample canary config is given below.
What happens is that every 1m, the percentage of failed requests to fna-v2 gets calculated from prometheus metrics. If it is under the configured failure threshold of 10%, then the percentage traffic to fn-v2 gets incremented by 30% and this cycle repeats until either the failure threshold has reached at which point, the deployment is rolled back or fn-v2 is receiving 100% of the user traffic.</p>

<pre><code class="language-bash">apiVersion: fission.io/v1
kind: CanaryConfig
metadata:
  name: canary-1
  namespace: default
spec:
  duration: 1m
  failureType: status-code
  failurethreshold: 10
  funcn: fn-a-v2
  funcn-1: fn-a-v1
  trigger: route-fna
  weightincrement: 30
</code></pre>

<h3 id="steps-to-setup-a-canary-config">Steps to setup a canary config</h3>

<ol>
<li>Create environment for fission function :</li>
</ol>

<pre><code class="language-bash">fission env create --name nodejs --image fission/node-env
</code></pre>

<ol>
<li>Create fission functions :</li>
</ol>

<pre><code class="language-bash">fission fn create --name fna-v1 --code hello.js --env nodejs
fission fn create --name fna-v2 --code hello2.js --env nodejs
</code></pre>

<ol>
<li>Create an http trigger to these functions :</li>
</ol>

<pre><code class="language-bash">fission route create --name route-fna --function fna-v1 --weight 100 --function fna-v2 --weight 0
</code></pre>

<ol>
<li>Create a canary config :</li>
</ol>

<pre><code class="language-bash">fission canary-config create --name canary-1 --funcN fna-v2 --funcN-1 fna-v1 --httptrigger route-fna --increment-step 30 --increment-interval 1m --failure-threshold 10
</code></pre>

<h3 id="steps-to-verify-the-status-of-a-canary-deployment">Steps to verify the status of a canary deployment</h3>

<pre><code class="language-bash">fission canary-config get --name canary-1
</code></pre>

<p>This prints the status of the canary deployment of the new version of the function.
The status is &ldquo;Pending&rdquo; if the canary deployment is in progress.
The status is &ldquo;Succeeded&rdquo; if the new version of the function is receiving 100% of the user traffic.
The status is &ldquo;Failed&rdquo; if the failure threshold reached for the new version of the function and as a result 100% of the traffic gets routed to the old version of the function(rollback).
The status is &ldquo;Aborted&rdquo; if there were some failures during the canary deployment.</p>

<h3 id="note">Note</h3>

<p>The <code>scrape_interval</code> for Prometheus server is 1m by default. If the &ldquo;duration&rdquo; parameter needs to be less than 1m, the <code>scrape_interval</code> parameter needs to configured to a much lower value.
This can be done by updating the config map for prometheus server. Just updating the config map is enough, prometheus server need not be restarted.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        

        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/0.12.0/js/clipboard.min.js?1541109125"></script>
    <script src="/0.12.0/js/perfect-scrollbar.min.js?1541109125"></script>
    <script src="/0.12.0/js/perfect-scrollbar.jquery.min.js?1541109125"></script>
    <script src="/0.12.0/js/jquery.sticky.js?1541109125"></script>
    <script src="/0.12.0/js/featherlight.min.js?1541109125"></script>
    <script src="/0.12.0/js/html5shiv-printshiv.min.js?1541109125"></script>
    <script src="/0.12.0/js/highlight.pack.js?1541109125"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/0.12.0/js/modernizr.custom.71422.js?1541109125"></script>
    <script src="/0.12.0/js/learn.js?1541109125"></script>
    <script src="/0.12.0/js/hugo-learn.js?1541109125"></script>

    <link href="/0.12.0/mermaid/mermaid.css?1541109125" type="text/css" rel="stylesheet" />
    <script src="/0.12.0/mermaid/mermaid.js?1541109125"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86980724-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript" src="//script.crazyegg.com/pages/scripts/0059/9755.js" async="async"></script>

  </body>
</html>

